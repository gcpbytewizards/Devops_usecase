steps:
  # Step 1: Clone the GitHub repository
  - name: 'gcr.io/cloud-builders/git'
    entrypoint: '/bin/bash'
    args:
      - '-c'
      - |
        git clone https://github.com/gcpbytewizards/Devops_usecase.git
        cd Devops_usecase
        git checkout $BRANCH_NAME;

  # Step 3: Check changes in the folder
  - name: 'gcr.io/cloud-builders/git'
    entrypoint: '/bin/bash'
    args:
      - '-c'
      - |
        # Find changed files and process them one by one
          status=$(git diff --name-status $_LAST_COMMIT $_CURRENT_COMMIT  airflow_code/* | grep -E '^(M|A|D)')
          file=$(git diff --name-status $_LAST_COMMIT $_CURRENT_COMMIT  airflow_code/* | grep -E '^(M|A|D)')
          if [ "$status" == "D" ]; then
            echo "File $file deleted in the current commit"
            # Remove the file from the GCS bucket
            gsutil rm gs://_COMPOSER_BUCKET/$file
          elif [ "$status" == "M" ] || [ "$status" == "A" ]; then
            echo "File $file modified or added in the current commit"
            # Upload the file to the GCS bucket
            gsutil cp airflow_code/$file gs://_COMPOSER_BUCKET/$file
          else
            echo "File $file has unknown status $status in the current commit"
          fi

substitutions:
  _LAST_COMMIT: FETCH_HEAD
  _BRANCH_NAME: main
  _CURRENT_COMMIT: HEAD

options:
  logging: CLOUD_LOGGING_ONLY

